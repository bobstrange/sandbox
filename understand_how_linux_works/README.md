# 試して理解 Linux のしくみ

### CPU のモード

- カーネルモード -> 制限なし
  - Linux の場合カーネルのみ
- ユーザーモード -> 制限あり

### システムコール

プロセスがカーネルに処理を依頼するための方法

```
プロセス     =================                 =================
          システムコール発行 ↓                ↑ システムコールから復帰
カーネル                       ================

CPU のモード | ユーザーモード | カーネルモード | ユーザーモード |
```

### システムコール発行の可視化

`strace` コマンドで、発行されるシステムコールを見ることができる

`-T` で発行されたシステムコールの所要時間
`-tt` でシステムコールが発行された日時

```bash
strace -o hello.log ./hello
```

`sar` コマンドで CPU の使用状況を見ることができる
sar Collect, report or save system activity information なので、system activity report の略？

```bash
sar -P 0 1 1
```

`-P 0` -> CPU0
`1` 1 秒ごと
`1` 1 回

結果

```bash
vagrant ssh -c "sar -P 0 1 5"
Linux 5.4.0-110-generic (vagrant)       10/21/2022      _x86_64_        (2 CPU)

02:03:43 PM     CPU     %user     %nice   %system   %iowait    %steal     %idle
02:03:44 PM       0      0.00      0.00      0.00      0.00      0.00    100.00
02:03:45 PM       0      0.00      0.00      0.00      0.00      0.00    100.00
02:03:46 PM       0      0.00      0.00      0.00      0.00      0.00    100.00
```

%user %nice がユーザーモードでプロセスを実行している時間の割合
%system がカーネルがシステムコールを処理している時間の割合

`taskset` コマンドで指定した CPU 上でコマンドを実行できるので、無限ループのプログラムを実行させて
`sar` コマンドで確認する。

```bash
chmod +x ./src/inf-loop.py
taskset -c 0 ./src/inf-loop.py &
```

```
vagrant@vagrant:~$ sar -P 0 1 10
Linux 5.4.0-110-generic (vagrant)       10/21/2022      _x86_64_        (2 CPU)

02:09:26 PM     CPU     %user     %nice   %system   %iowait    %steal     %idle
02:09:27 PM       0    100.00      0.00      0.00      0.00      0.00      0.00
02:09:28 PM       0    100.00      0.00      0.00      0.00      0.00      0.00
02:09:30 PM       0    100.00      0.00      0.00      0.00      0.00      0.00
02:09:31 PM       0    100.00      0.00      0.00      0.00      0.00      0.00
02:09:32 PM       0    100.00      0.00      0.00      0.00      0.00      0.00
02:09:33 PM       0    100.00      0.00      0.00      0.00      0.00      0.00
02:09:34 PM       0    100.00      0.00      0.00      0.00      0.00      0.00
02:09:37 PM       0    100.00      0.00      0.00      0.00      0.00      0.00
02:09:38 PM       0    100.00      0.00      0.00      0.00      0.00      0.00
02:09:39 PM       0    100.00      0.00      0.00      0.00      0.00      0.00
Average:          0    100.00      0.00      0.00      0.00      0.00      0.00
vagrant@vagrant:~$ sar -P 1 1 10
Linux 5.4.0-110-generic (vagrant)       10/21/2022      _x86_64_        (2 CPU)

02:09:47 PM     CPU     %user     %nice   %system   %iowait    %steal     %idle
02:09:48 PM       1      0.00      0.00      0.00      0.00      0.00    100.00
02:09:50 PM       1      0.00      0.00      0.00      0.00      0.00    100.00
02:09:51 PM       1      0.00      0.00      0.00      0.00      0.00    100.00
02:09:52 PM       1      0.00      0.00      0.00      0.00      0.00    100.00
02:09:53 PM       1      0.00      0.00      0.00      0.00      0.00    100.00
02:09:54 PM       1      0.64      0.00      0.00      0.00      0.00     99.36
02:09:56 PM       1      0.00      0.00      0.00      0.00      0.00    100.00
02:09:57 PM       1      0.00      0.00      0.00      0.00      0.00    100.00
02:09:58 PM       1      0.00      0.00      0.00      0.00      0.00    100.00
02:10:00 PM       1      0.00      0.00      0.00      0.00      0.00    100.00
Average:          1      0.08      0.00      0.00      0.00      0.00     99.92
```

%user が 100 になっている
CPU1 は何も動いていないので %idle 100 のまま

今度は、ループ内で、systemcall を発行する無限ループ

```bash
taskset -c ./src/003_syscall-inf-loop.py &
sar -P 0 1 5

Linux 5.4.0-110-generic (vagrant)       10/21/2022      _x86_64_        (2 CPU)

02:16:13 PM     CPU     %user     %nice   %system   %iowait    %steal     %idle
02:16:16 PM       0     69.70      0.00     30.30      0.00      0.00      0.00
02:16:18 PM       0     65.62      0.00     34.38      0.00      0.00      0.00
02:16:19 PM       0     47.83      0.00     52.17      0.00      0.00      0.00
02:16:20 PM       0     62.26      0.00     37.74      0.00      0.00      0.00
02:16:21 PM       0     64.10      0.00     35.90      0.00      0.00      0.00
Average:          0     63.85      0.00     36.15      0.00      0.00      0.00
```

すると %system の割合が増える

